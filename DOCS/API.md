<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [extension/background][1]
*   [setShelfEnabled][2]
    *   [Parameters][3]
*   [createContextMenu][4]
*   [postInstall][5]
    *   [Parameters][6]
*   [postStartup][7]
*   [sanitizeFilename][8]
    *   [Parameters][9]
*   [sanitizeFilename][10]
    *   [Parameters][11]
*   [sanitizeFilename][12]
    *   [Parameters][13]
    *   [Examples][14]
*   [normalizeTwitterUrl][15]
    *   [Parameters][16]
*   [normalizeTwitterUrl][17]
    *   [Parameters][18]
    *   [Examples][19]
*   [getBestCandidate][20]
    *   [Parameters][21]
*   [module][22]
*   [DEFAULTS][23]
*   [DEFAULTS][24]
*   [revealPasswords][25]
*   [observeForPasswords][26]
*   [enablePasteAndRightClick][27]
*   [basenameFromUrl][28]
*   [basenameFromUrl][29]
    *   [Parameters][30]
*   [basenameFromUrl][31]
    *   [Parameters][32]
*   [probeUrl][33]
    *   [Parameters][34]
*   [parseSrcset][35]
    *   [Parameters][36]
*   [parseSrcset][37]
    *   [Parameters][38]
    *   [Examples][39]
*   [chooseBestSrcsetEntry][40]
    *   [Parameters][41]
*   [chooseBestSrcsetEntry][42]
    *   [Parameters][43]
*   [urlFromBackgroundImage][44]
    *   [Parameters][45]
*   [urlFromBackgroundImage][46]
    *   [Parameters][47]
*   [findBestCandidateInDom][48]
    *   [Parameters][49]
*   [applyTemplateString][50]
    *   [Parameters][51]
*   [parseContentDisposition][52]
    *   [Parameters][53]
    *   [Examples][54]
*   [fetchWithTimeout][55]
    *   [Parameters][56]
    *   [Examples][57]
*   [performDownload][58]
    *   [Parameters][59]
*   [wrap][60]
    *   [Parameters][61]
*   [get][62]
*   [set][63]
    *   [Parameters][64]
*   [saveOptions][65]
*   [renderOptions][66]
    *   [Parameters][67]
*   [loadOptions][68]

## extension/background

background.js — Lambda MV3 service worker

Module summary
This module contains the top-level background/service-worker logic for the
extension. It wires Chrome runtime events, provides the context menu and
commands for user-initiated downloads, coordinates probing & filename
selection, and delegates the final download to the downloads API. The file
is written defensively so it can be executed in unit tests (via the
`chromeAdapter` test shim) or in a real Chrome MV3 environment.

Exported surface (for tests)

*   IMG\_DOWNLOAD\_MENU\_ID (string): id used for the context menu item
*   adapter (object): runtime adapter used (real `chrome` or test shim)
*   setShelfEnabled(enabled): Promise<void> — enable/disable the download shelf
*   createContextMenu(): void — create extension context menu entries
*   postInstall(details): Promise<void> — install-time initialization
*   postStartup(): Promise<void> — startup-time initialization
*   sanitizeFilename(name): string — conservative filename sanitizer (SW fallback)
*   normalizeTwitterUrl(url, filename): {url,filename} — normalize pbs.twimg.com image URLs
*   getBestCandidate(info, tab): Promise<{ok:boolean,url?:string,filename?:string,error?:string}> — select a download candidate
*   performDownload(candidate, callback?): Promise<{ok:boolean,id?:any,error?:string}> — trigger the download
*   applyTemplate(url, filename): Promise<string> — apply filename template from storage

Contracts & data shapes

*   Candidate: { url: string, filename: string }
*   Probe result: { ok: true, url: string, filename: string } or { ok: false, error: string }

Design notes

*   Defensive adapters: the `adapter` object abstracts chrome.\* APIs so tests
    can inject a lightweight shim. The code always checks that nested
    functions (e.g. adapter.downloads.download) exist before calling them.
*   Guarded optional deps: where useful the module prefers small helper
    libs (e.g. lodash helpers) when available at runtime, but defines
    in-file fallbacks so the unbundled MV3 service worker can load.
*   Error handling: methods attempt to return structured error objects rather
    than throwing to make background logic easier to test and resilient at
    runtime.

Edge cases considered

*   Missing or malformed URLs, blob/data: URLs, redirected responses, missing
    headers (Content-Type / Content-Disposition), CDN-hosted images (Twitter),
    and content scripts that may provide improved candidates.

Testing helpers

*   The module exports internal helpers (getBestCandidate, performDownload,
    etc.) so unit tests can call and assert behavior without side effects.

## setShelfEnabled

Set the download shelf visibility via the downloads API.

This function attempts to call the platform API exposed at
`adapter.downloads.setShelfEnabled(enabled, cb)` and resolves after the
callback runs. When the API is not available the function resolves
immediately (no-op). Errors are caught and logged; the returned promise
always resolves to allow best-effort application at install/startup.

### Parameters

*   `enabled` **[boolean][69]** true to show the download shelf, false to hide it.

Returns **[Promise][70]\<void>** Resolves after the API invocation or immediately when not available.

## createContextMenu

Create the extension context menu entries used for image download and
bypass actions.

This function prefers `adapter.contextMenus.create` when provided; it
performs defensive checks so it is safe to call in headless tests.

Returns **void**&#x20;

## postInstall

Handle runtime.onInstalled event.

Responsibilities:

*   Read persisted preference for the download-shelf (`disableShelf`) and
    apply it via `setShelfEnabled`.
*   Ensure the extension context menu entries are created.

The function uses `adapter.storage.sync.get` when available and falls back
to safe defaults. It never throws; errors are logged and handled.

### Parameters

*   `details` **[Object][71]** onInstalled details object provided by Chrome.

Returns **[Promise][70]\<void>**&#x20;

## postStartup

Handle runtime.onStartup event.

Reads the `disableShelf` preference and applies the shelf setting. This is
invoked when the service worker starts and is resilient to missing storage
APIs.

Returns **[Promise][70]\<void>**&#x20;

## sanitizeFilename

Conservative filename sanitizer used by the service worker.

Behavior:

*   Prefers the shared `./lib/sanitizeFilename` implementation when available
    (keeps a single canonical sanitizer in the lib). If the lib is not
    available, this function performs a conservative fallback sanitization.
*   Attempts to decode URI components, strips query and fragment-like
    fragments, replaces filesystem-problematic characters with underscores,
    and truncates to a safe maximum (255 bytes/characters).

### Parameters

*   `name` **[string][72]** Input filename or URL segment to sanitize.

Returns **[string][72]** A sanitized filename suitable for saving; never an empty string.

## sanitizeFilename

Determine the best download candidate for an image source URL.

Process overview:

1.  Validate input and optionally ask a content-script probe for a better URL
    and filename (via adapter.tabs.sendMessage).
2.  Normalize known provider URLs (e.g. Twitter) to request high-quality
    variants.
3.  If the filename lacks an extension, attempt a HEAD request to infer the
    content-type or parse `Content-Disposition` for a suggested filename.
4.  Apply a filename template (via applyTemplateFn) and sanitize the result.

### Parameters

*   `args` **{srcUrl: [string][72]}** Object containing the image source URL.
*   `tab` **[Object][71]** Tab-like object (should expose an `id` property) used
    when sending a probe message to the content script.
*   `options` **[Object][71]?** Optional helpers and overrides.

    *   `options.adapter` **[Object][71]?** Adapter that exposes `tabs.sendMessage`.
    *   `options.fetchFn` **[Function][73]?** Optional fetch implementation to use for HEAD probes.
    *   `options.applyTemplateFn` **[Function][73]?** Async function (url, filename) => templatedFilename.
    *   `options.fetchOptions` **[Object][71]?** Extra options passed to fetchWithTimeout when used.

Returns **[Promise][70]<({ok: `true`, url: [string][72], filename: [string][72]} | {ok: `false`, error: [string][72]})>** Resolves with the chosen URL and sanitized filename on success, or an
error object when selection fails.

## sanitizeFilename

Normalize and sanitize a filename string for cross-platform filesystem use.

This function prefers to use the `sanitize-filename` package when available.
It falls back to a conservative regex-based sanitizer when the package is
not present or decoding fails. The returned value is always a non-empty
string suitable for use as a filesystem filename; when input is empty or
cannot be normalized, the literal `'download'` is returned.

### Parameters

*   `name` **[string][72]** The input filename or URL segment to sanitize.

### Examples

```javascript
sanitizeFilename('example.jpg') // => 'example.jpg'
```

```javascript
sanitizeFilename('a/b\c: d?e') // => 'a_b_c_ d_e'
```

Returns **[string][72]** A sanitized filename (max length 255). Never returns an empty string.

## normalizeTwitterUrl

Normalize Twitter `pbs.twimg.com` media URLs to request a higher-quality
variant and derive a consistent filename.

*   If the URL is not a Twitter media URL this function returns the inputs
    unchanged.
*   Ensures query parameters include `name=large` and `format` when known.
*   Infers a sensible file extension when possible and normalizes `jpg` -> `jpeg`.

### Parameters

*   `url` **[string][72]** Source URL possibly pointing at Twitter media CDN.
*   `filename` **[string][72]** Candidate filename to use as a fallback.

Returns **{url: [string][72], filename: [string][72]}** Normalized URL and filename.

## normalizeTwitterUrl

Normalize Twitter image URLs to request the `large` variant and derive a
sensible filename.

*   Only operates on `pbs.twimg.com` media endpoints whose path begins with
    `/media/`.
*   Ensures the `name=large` query parameter is present and attempts to infer
    a file extension from the pathname or `format` query parameter.
*   Returns the original inputs unchanged if parsing fails or the URL does not
    look like a Twitter media resource.

### Parameters

*   `url` **[string][72]** The original image URL.
*   `filename` **[string][72]** An optional candidate filename used as fallback.

### Examples

```javascript
normalizeTwitterUrl('https://pbs.twimg.com/media/ABC123.jpg', 'x.jpg')
// => { url: 'https://pbs.twimg.com/media/ABC123.jpg?format=jpg&name=large', filename: 'ABC123.jpeg' }
```

Returns **{url: [string][72], filename: [string][72]}** Object with possibly-updated URL and filename.

## getBestCandidate

High-level selector for the best download candidate for a given image
resource. This function orchestrates content-script probing, provider
normalization (Twitter), HEAD probes to infer content-type or
content-disposition filename hints, application of the filename template,
and final sanitization.

Contract:

*   Accepts `info` with `{ srcUrl }` and a `tab` object used for content
    script messaging.
*   Returns { ok: true, url, filename } on success or { ok: false, error }
    when unable to select a candidate.

Error & edge handling:

*   If the content script probe is unavailable or returns null, the function
    falls back to network probing.
*   Network HEAD probes are performed with `fetchWithTimeout` (defaults used
    elsewhere) and will be skipped if no fetch implementation is provided.

### Parameters

*   `info` **{srcUrl: [string][72]}** Object containing image `srcUrl`.
*   `tab` **[Object][71]** Tab-like object (must expose `id`) used to message content scripts.

## module

Exports for unit testing and runtime introspection.

The exported values are intentionally the minimal surface needed by tests
so the background service worker can remain side-effect free while under
test control. Test suites may override `adapter` or call `getBestCandidate`
and `performDownload` directly.

## DEFAULTS

Content script to bypass common site protections.

*   Reveals password inputs (converts type=password -> type=text) when enabled.
*   Enables paste and context-menu actions by preventing page handlers from
    intercepting these events.

The script reads preferences from `chrome.storage.sync` (with local fallback)
and responds to runtime messages `{type: 'applyBypassNow', ...}` to apply
settings immediately for the current page.

## DEFAULTS

Options page logic for Lambda extension

Exports (attached to window/global for tests):

*   saveOptions(): saves UI values to chrome.storage (prefers storage.sync)
*   loadOptions(): loads values and calls renderOptions
*   renderOptions(cfg): applies a config object to the UI

Storage integration uses `wrap` from `./lib/storageWrapper` with sync/local fallback.

Inputs/Outputs:

*   UI fields are gathered from DOM elements with ids prefixed `opt-` and persisted to storage.
*   `loadOptions` reads storage and calls `renderOptions(cfg)` where `cfg` is merged with DEFAULTS.

Side-effects:

*   Persists preferences to `chrome.storage.sync` (falls back to `chrome.storage.local`).
*   Sends a runtime message `{ type: 'applyDisableShelf', value }` to request immediate application of the download-shelf preference.
*   Updates the `#status` element text to indicate save completion.

Error modes:

*   Storage operations are best-effort; failures are silently ignored to avoid breaking the UI. `loadOptions` falls back to callback-style APIs when promise-based wrapper fails.

## revealPasswords

Convert existing password inputs to plain text for visibility.

## observeForPasswords

Observe DOM mutations to convert newly-added password inputs to text.

## enablePasteAndRightClick

Ensure paste and context-menu actions are allowed by clearing inline
handlers and adding capture-phase listeners that prevent page handlers
from blocking default behavior.

## basenameFromUrl

Content script: image probe helper

Listens for messages from the background script to probe an image URL and
return richer metadata (content-type, better candidate URL from the DOM,
inferred filename). This script runs in the page context and performs
lightweight network probes (HEAD/GET) when possible.

Message API:

*   {type: 'probeImage', src: string} -> responds with { ok:true, url, filename, contentType }
*   {type: 'probeAndDownloadVisible'} -> finds a visible image and asks background to download it

## basenameFromUrl

Extract a decoded basename from a URL path. Falls back to 'image'.

### Parameters

*   `url` **[string][72]**&#x20;

Returns **[string][72]**&#x20;

## basenameFromUrl

Extract a decoded basename from a URL's path component.

If the URL is invalid or the path does not contain a basename, returns
the fallback string `'image'`.

### Parameters

*   `url` **[string][72]** The URL to extract the basename from.

Returns **[string][72]** Decoded basename or `'image'` on error.

## probeUrl

Probe a URL using HEAD (and optionally a ranged GET) to extract
content-type and content-disposition filename hints.

### Parameters

*   `url` **[string][72]**&#x20;

Returns **[Promise][70]<{ok: [boolean][69], url: [string][72], filename: [string][72], contentType: [string][72]}>**&#x20;

## parseSrcset

Parse an img\[srcset] attribute into candidate entries.

### Parameters

*   `srcset` **[string][72]**&#x20;

Returns **[Array][74]<{url: [string][72], w: [number][75], x: [number][75]}>**&#x20;

## parseSrcset

Parse an HTML `srcset` attribute value into structured candidate entries.

Each returned entry has the shape { url: string, w: number, x: number } where
`w` denotes the width descriptor (in pixels) if present, and `x` denotes the
pixel density descriptor (e.g. 1, 2). If descriptors are absent they default
to `{w:0, x:1}`.

### Parameters

*   `srcset` **[string][72]** The raw contents of an `srcset` attribute.

### Examples

```javascript
parseSrcset('a.jpg 1x, b.jpg 2x')
// => [{url:'a.jpg',w:0,x:1},{url:'b.jpg',w:0,x:2}]
```

Returns **[Array][74]<{url: [string][72], w: [number][75], x: [number][75]}>** Array of parsed entries. Returns an empty array for invalid input.

## chooseBestSrcsetEntry

Choose the best URL from parsed srcset entries (prefer width then density).

### Parameters

*   `entries` **[Array][74]<{url: [string][72], w: [number][75], x: [number][75]}>**&#x20;

Returns **([string][72] | null)**&#x20;

## chooseBestSrcsetEntry

Select the best candidate from parsed srcset entries.

Selection strategy:

*   Prefer the entry with the largest `w` (width) value.
*   If widths are equal, prefer the larger `x` (density).

### Parameters

*   `entries` **[Array][74]<{url: [string][72], w: [number][75], x: [number][75]}>** Parsed srcset entries.

Returns **([string][72] | null)** The selected URL, or null when no entries are available.

## urlFromBackgroundImage

Extract a URL from a CSS background-image value like `url("...")`.

### Parameters

*   `str` **[string][72]**&#x20;

Returns **([string][72] | null)**&#x20;

## urlFromBackgroundImage

Extract the URL contained inside a CSS `background-image: url(...)` value.

### Parameters

*   `str` **[string][72]** CSS `background-image` value (e.g. `url("/a.png")`).

Returns **([string][72] | null)** The extracted URL string or null when not present.

## findBestCandidateInDom

Search the DOM for elements that reference `src` and try to return a
higher-quality candidate (from srcset, data attributes, or background images).

### Parameters

*   `src` **[string][72]**&#x20;

Returns **([string][72] | null)**&#x20;

## applyTemplateString

Apply a simple filename template to an URL and base filename.

Supported placeholders:

*   {domain}    -> the request hostname with leading `www.` removed
*   {basename}  -> the provided filename
*   {timestamp} -> current epoch ms

This is intentionally lightweight and returns the original `filename`
on any error during parsing or templating.

### Parameters

*   `tpl` **[string][72]** Template string. (optional, default `'{domain}/{basename}'`)
*   `url` **[string][72]** Resource URL used to extract the domain.
*   `filename` **[string][72]** Base filename to insert into the template.

Returns **[string][72]** Templated filename (not sanitized). On error returns `filename`.

## parseContentDisposition

Parse a `Content-Disposition` header value and extract a filename when
present. Handles both `filename` and the RFC 5987 `filename*` (UTF-8
percent-encoded) forms.

### Parameters

*   `header` **[string][72]** The value of the `Content-Disposition` header.

### Examples

```javascript
parseContentDisposition('attachment; filename="a.jpg"') // => 'a.jpg'
parseContentDisposition("attachment; filename*=UTF-8''a%20b.jpg") // => 'a b.jpg'
```

Returns **([string][72] | null)** The decoded filename when found, otherwise null.

## fetchWithTimeout

Perform a fetch with a timeout and optional retry behavior.

*   Uses an injected `fetchFn` when provided (useful for testing).
*   Prefers `ky` when available and no `fetchFn` is supplied. Falls back to
    the global `fetch` if present. Throws if no fetch implementation can be
    found.
*   Implements a simple retry/backoff loop for transient failures.

### Parameters

*   `url` **[string][72]** Resource URL to fetch.
*   `init` **RequestInit?** Standard fetch init options (method, headers, body, etc.). (optional, default `{}`)
*   `opts` **[Object][71]?** Additional options. (optional, default `{}`)

    *   `opts.timeout` **[number][75]** Timeout in milliseconds before aborting the request. (optional, default `5000`)
    *   `opts.retries` **[number][75]** Number of retry attempts on failure (0 = no retries). (optional, default `1`)
    *   `opts.fetchFn` **([Function][73] | null)?** Optional fetch implementation to use instead of global fetch/ky. (optional, default `typeof fetch!=='undefined'?fetch:null`)

### Examples

```javascript
// use global fetch with 3s timeout and 2 retries
await fetchWithTimeout('https://example.com/image.jpg', {}, { timeout: 3000, retries: 2 })
```

*   Throws **[Error][76]** If no fetch implementation is available or all retries fail.

Returns **[Promise][70]<[Response][77]>** Resolves with the fetch Response when successful.

## performDownload

Initiate a download using the provided adapter (typically the `chrome`
namespace or a test adapter). Returns a promise that resolves when the
downloads API callback is invoked.

Note: This function uses the adapter pattern to remain testable outside of
the real Chrome runtime. It performs guarded checks for the required
`downloads.download` function and returns structured errors instead of
throwing.

### Parameters

*   `adapter` **[Object][71]** Object exposing `downloads.download` (e.g. chrome).
*   `candidate` **{url: [string][72], filename: [string][72]}** Download candidate with a URL and sanitized filename.

Returns **[Promise][70]<({ok: `true`, id: any} | {ok: `false`, error: [string][72]})>** Resolves with download id on success, or an error object.

## wrap

storageWrapper.js
Promise-based wrapper around chrome.storage that prefers sync and falls back to local.
Exports: wrap(storage, runtime) -> { get(keys): Promise, set(obj): Promise }

Inputs:

*   storage: chrome.storage or an object with sync/local get/set methods
*   runtime: chrome.runtime (optional) used to inspect runtime.lastError

Behavior:

*   Attempts sync.get/set first; on runtime.lastError or thrown errors falls back to local
*   Always resolves (never rejects) with a best-effort result

### Parameters

*   `storage` &#x20;
*   `runtime` &#x20;

## get

Wrap the provided storage object (chrome.storage) into a promise-based
API that prefers `sync` and falls back to `local` when errors occur.

The returned object exposes `get(keys)` and `set(obj)` which both resolve
successfully even on underlying errors (best-effort semantics).

## set

Persist an object to storage. Attempts `sync.set` first, falling back to
`local.set` on failure. Always resolves (never rejects).

### Parameters

*   `obj` **[Object][71]** Key/value map to persist.

Returns **[Promise][70]\<void>**&#x20;

## saveOptions

Save current options from the UI into chrome.storage (prefers sync).
Emits a runtime message to apply the `disableShelf` preference immediately.
This function is resilient to storage errors and performs best-effort writes.

Returns **[Promise][70]\<void>**&#x20;

## renderOptions

Render a configuration object into the options UI fields.

### Parameters

*   `cfg` **[Object][71]** Configuration object containing option values. (optional, default `{}`)

## loadOptions

Load options from storage and render them into the UI. Prefers the
promise-based `storageClient` when available, with a callback-style
fallback to `chrome.storage`.

Returns **[Promise][70]\<void>**&#x20;

[1]: #extensionbackground

[2]: #setshelfenabled

[3]: #parameters

[4]: #createcontextmenu

[5]: #postinstall

[6]: #parameters-1

[7]: #poststartup

[8]: #sanitizefilename

[9]: #parameters-2

[10]: #sanitizefilename-1

[11]: #parameters-3

[12]: #sanitizefilename-2

[13]: #parameters-4

[14]: #examples

[15]: #normalizetwitterurl

[16]: #parameters-5

[17]: #normalizetwitterurl-1

[18]: #parameters-6

[19]: #examples-1

[20]: #getbestcandidate

[21]: #parameters-7

[22]: #module

[23]: #defaults

[24]: #defaults-1

[25]: #revealpasswords

[26]: #observeforpasswords

[27]: #enablepasteandrightclick

[28]: #basenamefromurl

[29]: #basenamefromurl-1

[30]: #parameters-8

[31]: #basenamefromurl-2

[32]: #parameters-9

[33]: #probeurl

[34]: #parameters-10

[35]: #parsesrcset

[36]: #parameters-11

[37]: #parsesrcset-1

[38]: #parameters-12

[39]: #examples-2

[40]: #choosebestsrcsetentry

[41]: #parameters-13

[42]: #choosebestsrcsetentry-1

[43]: #parameters-14

[44]: #urlfrombackgroundimage

[45]: #parameters-15

[46]: #urlfrombackgroundimage-1

[47]: #parameters-16

[48]: #findbestcandidateindom

[49]: #parameters-17

[50]: #applytemplatestring

[51]: #parameters-18

[52]: #parsecontentdisposition

[53]: #parameters-19

[54]: #examples-3

[55]: #fetchwithtimeout

[56]: #parameters-20

[57]: #examples-4

[58]: #performdownload

[59]: #parameters-21

[60]: #wrap

[61]: #parameters-22

[62]: #get

[63]: #set

[64]: #parameters-23

[65]: #saveoptions

[66]: #renderoptions

[67]: #parameters-24

[68]: #loadoptions

[69]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean

[70]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise

[71]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[72]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String

[73]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[74]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array

[75]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number

[76]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Error

[77]: https://developer.mozilla.org/docs/Web/Guide/HTML/HTML5
